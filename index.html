<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather App with Video Background & Chatbot</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body {
      min-height: 100vh;
      font-family: Arial, sans-serif;
      color: #333;
      margin: 0;
      overflow-x: hidden;
      background: linear-gradient(135deg, #71b7e6, #9b59b6);
      position: relative;
    }
    #bg-video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      object-position: center;
      z-index: -3;
      opacity: 0.8;
      transition: opacity 0.6s ease;
      pointer-events: none;
    }
    .gif-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.15);
      z-index: -2;
      pointer-events: none;
    }
    .container {
      max-width: 420px;
      width: 94vw;
      margin: 0 auto;
      padding: 30px 0 0 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 3;
    }
    .weather-card {
      background: rgba(255,255,255,0.60);
      border-radius: 15px;
      padding: 21px;
      max-width: 384px;
      width: 100%;
      margin: 38px auto 10px auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      text-align: center;
      z-index: 10;
      position: relative;
    }
    .weather-card h1 { font-size: 1.7rem; margin: 7px 0 3px 0; }
    .weather-emoji { font-size: 2.4rem; margin: 8px 0; }
    .weather-animated-icon {
      width: 65px;
      height: 65px;
      display: block;
      margin: 10px auto 14px auto;
      pointer-events: none;
      user-select: none;
    }
    .temperature { font-size: 2.2rem; font-weight: bold; }
    .description { font-size: 1.09rem; color: #555; margin-bottom: 12px;}
    .details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px; margin-top: 13px;
    }
    .detail-item {
      background: rgba(0,0,0,0.05);
      padding: 8px;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .error { color: #e74c3c; font-size: 1rem; margin: 7px; display: none; }
    .loading { font-size: 1rem; color: #555; margin: 10px 0 5px 0; display: none; }
    .chatbot-fab {
      position: fixed;
      bottom: 28px;
      right: 28px;
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 62px;
      height: 62px;
      font-size: 2rem;
      box-shadow: 0 3px 12px rgba(34,34,34,0.12);
      cursor: pointer;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.2s;
    }
    .chatbot-fab:hover {
      background: #34495e;
      transform: scale(1.08);
    }
    .chatbot-modal {
      display: none;
      position: fixed;
      top: 0; right: 0;
      width: 350px;
      height: 100vh;
      background: rgba(255,255,255,0.98);
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 200;
      flex-direction: column;
    }
    .chatbot-modal.open { display: flex; }
    .chatbot-header {
      background: #2c3e50;
      color: #fff;
      padding: 13px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .close-chat { background: none; border: none; font-size: 1.15rem; color: #fff; cursor: pointer;}
    .chatbot-body {
      flex-grow: 1;
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {max-width:78%;padding:10px;border-radius:10px;font-size:0.94rem;}
    .user-message {background:#71b7e6;color:white;align-self:flex-end;}
    .ai-message {background:#e0e0e0;color:#333;align-self:flex-start;}
    .chatbot-input {
      padding: 12px;
      border-top: 1px solid #eee;
      display: flex; gap: 10px;
    }
    .chatbot-input input {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #bbb;
      border-radius: 18px;
      font-size: 1rem;
      outline: none;
      background: #fafafa;
    }
    .chatbot-input button {
      background: #2c3e50;
      color: #fff;
      border: none;
      border-radius: 15px;
      padding: 8px 16px;
      font-size: 1rem;
      cursor: pointer;
    }
    .chatbot-input button:hover { background: #34495e;}
    .aqi-card {
      background: rgba(255, 255, 255, 0.42);
      box-shadow: 0 2px 15px rgba(0,0,0,0.09);
      border-radius: 15px;
      backdrop-filter: blur(4px);
      max-width: 384px;
      width: 100%;
      margin: 0 auto 30px auto;
      padding: 18px 18px 14px 18px;
      text-align: center;
      position: relative;
      z-index: 10;
    }
    .aqi-card h2 {
      margin: 0 0 10px 0;
      font-size: 1.12rem;
    }
    .aqi-value {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .aqi-desc {
      font-size: 1rem;
      margin-bottom: 9px;
      color: #555;
    }
    .health-advice {
      font-size: 0.96rem;
      color: #613d17;
    }
    @media (max-width:520px){
      .weather-card { max-width: 99vw; padding: 11px; }
      .container { width: 99vw; }
      .chatbot-fab { bottom: 13px; right: 13px; width: 52px; height: 52px; font-size: 1.6rem; }
      .chatbot-modal { width: 100vw;}
      .aqi-card { max-width:99vw; }
    }
  </style>
</head>
<body>
  <!-- Video weather background -->
  <video id="bg-video" autoplay loop muted playsinline>
    <source id="bg-video-source" src="background/Sunny.mp4" type="video/mp4">
  </video>
  <div class="gif-overlay"></div>
  <div class="container">

    <div class="weather-card">
      <h1 id="location">Getting location...</h1>

      <!-- Animated Weather Icon -->
      <img id="weather-animated-icon"
           class="weather-animated-icon"
           src="Icons/clear-morning.gif"
           alt="Weather Icon"
           style="display:none;" />
      <!-- Fallback emoji (hidden when GIF is visible) -->
      <div class="weather-emoji" id="weather-emoji">‚è≥</div>

      <div class="temperature" id="temperature">--¬∞C</div>
      <div class="description" id="description">--</div>
      <div class="details">
        <div class="detail-item">Humidity: <span id="humidity">--%</span></div>
        <div class="detail-item">Wind: <span id="wind">-- km/h</span></div>
        <div class="detail-item">Feels Like: <span id="feels-like">--¬∞C</span></div>
        <div class="detail-item">Pressure: <span id="pressure">-- hPa</span></div>
      </div>
      <div class="error" id="error"></div>
      <div class="loading" id="loading">Loading weather data...</div>
    </div>
    <!-- AQI Card -->
    <div class="aqi-card" id="aqi-card">
      <h2>Air Quality Index</h2>
      <div class="aqi-value" id="aqi-value">--</div>
      <div class="aqi-desc" id="aqi-desc">Fetching AQI...</div>
      <div class="health-advice" id="health-advice"></div>
    </div>
  </div>
  <!-- Floating Chatbot FAB -->
  <button class="chatbot-fab" id="chatbot-fab" title="Ask WeatherBot!">üí¨</button>
  <!-- Chatbot Modal -->
  <div class="chatbot-modal" id="chatbot-modal">
    <div class="chatbot-header">
      <div>WeatherBot</div>
      <button class="close-chat" id="close-chat">‚úñ</button>
    </div>
    <div class="chatbot-body" id="chat-body">
      <div class="ai-message">Hello! Ask me about the weather or anything else üå¶Ô∏è</div>
    </div>
    <div class="chatbot-input">
      <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
      <button id="send-message">Send</button>
    </div>
  </div>
  <script>
    // --- SET THESE TO YOUR API KEYS ---
    const WEATHER_API_KEY = 'f1908714c7112fd642dcf9863c219a66'; // <-- replace
    const GEMINI_API_KEY = 'AIzaSyDamaL_ZEMs8aOKMtn5foPtGRK8k-rkoCk';   // <-- replace

    // --- Weather Video Mapping ---
    const weatherVideos = {
      clear: "background/Sunny.mp4",
      sunny: "background/Sunny.mp4",
      clouds: "background/Cloudy.mp4",
      cloudy: "background/Cloudy.mp4",
      rain: "background/Rain.mp4",
      drizzle: "background/Rain.mp4",
      snow: "background/Snow.mp4",
      thunderstorm: "background/ThunderStorm.mp4",
      "sunset-cloudy": "background/Sunset-Cloudy.mp4",
      "few clouds": "background/Sunset-Cloudy.mp4",
      "scattered clouds": "background/Cloudy.mp4",
      "broken clouds": "background/Cloudy.mp4",
      "overcast clouds": "background/Cloudy.mp4",
      default: "background/Sunny.mp4"
    };
    const weatherEmojis = {
      'clear sky': '‚òÄÔ∏è','few clouds': 'üå§Ô∏è','scattered clouds': '‚õÖ',
      'broken clouds': '‚òÅÔ∏è','overcast clouds': '‚òÅÔ∏è','shower rain': 'üå¶Ô∏è',
      'rain': 'üåßÔ∏è','thunderstorm': '‚õàÔ∏è','snow': '‚ùÑÔ∏è','mist': 'üå´Ô∏è',
      'fog': 'üå´Ô∏è','haze': 'üå´Ô∏è','dust': 'üí®','sand': 'üí®',
      'smoke': 'üí®','squall': 'üí®','tornado': 'üå™Ô∏è'
    };
    let currentWeatherData = null;

    // --- WEATHER VIDEO LOGIC ---
    function setWeatherVideo(main = '', desc = '') {
      const videoElem = document.getElementById('bg-video');
      const sourceElem = document.getElementById('bg-video-source');
      let selectedVideo = weatherVideos.default;
      main = main.toLowerCase(); desc = desc.toLowerCase();
      if (weatherVideos[desc]) selectedVideo = weatherVideos[desc];
      else if (weatherVideos[main]) selectedVideo = weatherVideos[main];
      else {
        if (main.includes('clear') || desc.includes('clear') || desc.includes('sunny')) selectedVideo = weatherVideos.clear;
        else if (main.includes('cloud') || desc.includes('cloud')) selectedVideo = weatherVideos.clouds;
        else if (main.includes('rain') || desc.includes('rain') || main.includes('drizzle')) selectedVideo = weatherVideos.rain;
        else if (main.includes('snow') || desc.includes('snow')) selectedVideo = weatherVideos.snow;
        else if (main.includes('thunder') || desc.includes('thunder')) selectedVideo = weatherVideos.thunderstorm;
      }
      if (!sourceElem.src.endsWith(selectedVideo.split('/').pop())) {
        videoElem.style.opacity = 0.3;
        setTimeout(() => {
          sourceElem.src = selectedVideo;
          videoElem.load();
          videoElem.oncanplay = () => { videoElem.style.opacity = 0.8; videoElem.oncanplay = null; };
        }, 320);
      }
    }

    // --- WEATHER & AQI API FETCH ---
    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      const error = document.getElementById('error');
      error.style.display = 'block';
      error.textContent = msg;
      document.getElementById('weather-emoji').textContent = '‚ö†Ô∏è';
      setWeatherVideo('', '');
    }
    function hideError() { document.getElementById('error').style.display = 'none'; }
    function showLoading(msg) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('loading').textContent = msg || "Loading...";
    }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }

    async function getWeatherByCoords(lat, lon) {
      hideError();
      showLoading();
      try {
        let url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${WEATHER_API_KEY}`;
        const response = await fetch(url);
        if(!response.ok) throw new Error("Not found");
        const data = await response.json();
        updateWeatherUI(data);
        // Fetch AQI after weather loaded
        getAQI(lat, lon);
      } catch {
        showError("Unable to fetch weather. Try again later.");
      }
    }

    // --- ANIMATED ICON MAPPING ---
    const iconMap = {
      // Strictly matching your provided file names (case sensitive, as per screenshot)
      // Map possible weather descriptions or fallback categories to the file names
      "clear after rain": "Clear after rain.gif",
      "clear sky": "clear-morning.gif",
      "clear": "clear-morning.gif",                  // fallback for unknown "clear"
      "few clouds": "Cloudy-day.gif",
      "scattered clouds": "cloudy.gif",
      "broken clouds": "cloudy.gif",
      "overcast clouds": "cloudy.gif",
      "cloudy": "cloudy.gif",
      "night clear": "night-clear.gif",
      "night-clear": "night-clear.gif",
      "night-cloudy": "night-cloudy.gif",
      "night cloudy": "night-cloudy.gif",
      "shower rain": "rainy.gif",
      "rain": "rainy.gif",
      "drizzle": "rainy.gif",
      "thunderstorm": "storm.gif",
      "storm": "storm.gif",
      "snow": "snowy.gif",
      "snowy": "snowy.gif",
      "very hot": "very-hot.gif",
      "hot": "very-hot.gif"
    };

    // Update weather UI and select matching GIF icon
    function updateWeatherUI(data) {
      currentWeatherData = data;
      hideLoading(); hideError();
      document.getElementById('location').textContent = data.name || "--";
      document.getElementById('temperature').textContent = Math.round(data.main.temp) + "¬∞C";
      document.getElementById('description').textContent = data.weather[0].description;
      document.getElementById('humidity').textContent = data.main.humidity + "%";
      document.getElementById('wind').textContent = (data.wind.speed*3.6).toFixed(1) + " km/h";
      document.getElementById('feels-like').textContent = Math.round(data.main.feels_like) + "¬∞C";
      document.getElementById('pressure').textContent = data.main.pressure + " hPa";

      // Animated icon matching using your icon filenames
      let desc = data.weather[0].description ? data.weather[0].description.toLowerCase() : "";
      let main = data.weather[0].main ? data.weather[0].main.toLowerCase() : "";
      let hour = (new Date()).getHours();
      let iconFile = null;
      // Night detection for clear & cloudy
      if ((desc.includes('clear') || main.includes('clear')) && (hour >= 19 || hour < 7)) {
        iconFile = "night-clear.gif";
      } else if (desc.includes('cloud') && (hour >= 19 || hour < 7)) {
        iconFile = "night-cloudy.gif";
      } else if (iconMap[desc]) {
        iconFile = iconMap[desc];
      } else if (iconMap[main]) {
        iconFile = iconMap[main];
      } else if (desc.includes('rain')) {
        iconFile = "rainy.gif";
      } else if (desc.includes('snow')) {
        iconFile = "snowy.gif";
      } else if (desc.includes('storm') || desc.includes('thunder')) {
        iconFile = "storm.gif";
      } else if (desc.includes('hot') || main.includes('hot')) {
        iconFile = "very-hot.gif";
      } else {
        iconFile = "clear-morning.gif"; // fallback
      }

      // Set the icon
      let img = document.getElementById('weather-animated-icon');
      img.src = "Icons/" + iconFile;
      img.style.display = "block";
      document.getElementById('weather-emoji').style.display = "none"; // Hide emoji fallback

      setWeatherVideo(data.weather[0].main, data.weather[0].description);
    }

    // AQI FETCH FUNCTIONS (unchanged)
    async function getAQI(lat, lon) {
      const AQI_API = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}`;
      try {
        const response = await fetch(AQI_API);
        if (!response.ok) throw new Error('AQI fetch failed');
        const data = await response.json();
        updateAQICard(data);
      } catch (err) {
        document.getElementById('aqi-value').textContent = '--';
        document.getElementById('aqi-desc').textContent = 'Unable to get AQI.';
        document.getElementById('health-advice').textContent = '';
      }
    }

    function updateAQICard(data) {
      if (!data || !data.list || !data.list[0]) return;
      const aqi = data.list[0].main.aqi;
      const descriptions = [
        "Unavailable", "Good", "Fair", "Moderate", "Poor", "Very Poor"
      ];
      const advices = [
        "", "Air is good. Enjoy outdoor activities.",
        "Air is fair. Sensitive individuals should consider precautions.",
        "Air is moderate. Limit lengthy outdoor exertion.",
        "Poor air. Children and sensitive groups avoid prolonged outdoor activity.",
        "Air quality is very poor. Stay indoors if possible."
      ];
      document.getElementById('aqi-value').textContent = aqi;
      document.getElementById('aqi-desc').textContent = descriptions[aqi] || "Unknown";
      document.getElementById('health-advice').textContent = advices[aqi] || "";
    }

    // Get geolocation and weather on load
    window.onload = function() {
      if (navigator.geolocation) {
        showLoading("Getting your location...");
        navigator.geolocation.getCurrentPosition(
          pos => getWeatherByCoords(pos.coords.latitude, pos.coords.longitude),
          () => showError("Location denied. Cannot fetch weather.")
        );
      } else {
        showError("Sorry Geolocation not supported.");
      }
    };

    // --- CHATBOT MODAL LOGIC (unchanged) ---
    const chatbotFab = document.getElementById("chatbot-fab");
    const chatbotModal = document.getElementById("chatbot-modal");
    const closeChat = document.getElementById("close-chat");
    const chatInput = document.getElementById("chat-input");
    const chatBody = document.getElementById("chat-body");
    const sendBtn = document.getElementById("send-message");

    chatbotFab.onclick = () => chatbotModal.classList.add('open');
    closeChat.onclick = () => chatbotModal.classList.remove('open');

    function addMessage(content, isUser) {
      const m = document.createElement('div');
      m.className = 'message ' + (isUser ? 'user-message' : 'ai-message');
      m.textContent = content;
      chatBody.appendChild(m);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    function showTyping() {
      const div = document.createElement('div');
      div.classList.add('ai-message');
      div.id = 'typing';
      div.textContent = "WeatherBot is typing‚Ä¶";
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    function removeTyping() {
      const t = document.getElementById('typing');
      if (t) t.remove();
    }
    async function getGeminiResponse(message) {
      const tempDetails = currentWeatherData
        ? `Temperature: ${Math.round(currentWeatherData.main.temp)}¬∞C, Feels Like: ${Math.round(currentWeatherData.main.feels_like)}¬∞C, ${currentWeatherData.weather[0].description}, Humidity: ${currentWeatherData.main.humidity}%, Wind: ${(currentWeatherData.wind.speed * 3.6).toFixed(1)} km/h`
        : 'Weather data unavailable';
      const payload = {
        contents: [{
          parts: [{
            text: `Based on the current temperature ${tempDetails} ${message}`
          }]
        }]
      };
      try {
        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
          }
        );
        const data = await response.json();
        if (
          data.candidates &&
          data.candidates.length > 0 &&
          data.candidates[0].content &&
          data.candidates[0].content.parts &&
          data.candidates[0].content.parts.length > 0
        ) {
          return data.candidates[0].content.parts[0].text || "I'm here to help!";
        }
        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.text) {
          return data.candidates[0].content.text;
        }
        if (data.promptFeedback && data.promptFeedback.blockReason) {
          return "Sorry, my response was blocked due to API policy (" + data.promptFeedback.blockReason + ").";
        }
        return 'Sorry for delay, I did not get a valid reply from Gemini right now.';
      } catch (err) {
        return 'Sorry, I could not process your request right now.';
      }
    }
    async function handleSendMessage() {
      const msg = chatInput.value.trim();
      if (!msg) return;
      addMessage(msg, true);
      chatInput.value = '';
      showTyping();
      let aiMsg = await getGeminiResponse(msg);
      removeTyping();
      addMessage(aiMsg, false);
    }
    sendBtn.onclick = handleSendMessage;
    chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') handleSendMessage(); });
  </script>
</body>
</html>
